name: CA360 Portal Gates

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  gates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate Portal Structure
        run: |
          echo "=== CA360º Portal Gates Validation ==="
          echo ""
          
          # Gate 1: Filename validation (v6.0 nomenclature) with scope reporting
          echo "Gate 1: Validating v6.0 nomenclature compliance..."
          if [ -f "configs/nomenclature/v6/regex_constraints.json" ]; then
            echo "✓ Regex constraints config found"
          else
            echo "✗ ERROR: Missing regex_constraints.json"
            exit 1
          fi
          
          # Report scope boundary explicitly
          echo ""
          echo "v6.0 Scope Boundary Report:"
          IN_SCOPE=$(find CAXS/LEDGERS -name "*.md" ! -name "README.md" 2>/dev/null | wc -l)
          OUT_OF_SCOPE=$(find CAXS -name "README.md" -o -name "*_template.md" 2>/dev/null | wc -l)
          echo "  In-scope files (ledgers/deliverables/registries): $IN_SCOPE"
          echo "  Out-of-scope files (READMEs/templates/configs): $OUT_OF_SCOPE"
          echo "  ℹ Info: Only in-scope files require PROJECT=AMPEL360 in filename"
          
          # Gate 2: AoR validation (14 stakeholders including STK_CEGT)
          echo "Gate 2: Validating AoR completeness (14 stakeholders)..."
          AOR_COUNT=$(find CAXS/AoR -maxdepth 1 -type d -name "STK_*" | wc -l)
          if [ "$AOR_COUNT" -eq 14 ]; then
            echo "✓ All 14 AoR stakeholders present"
          else
            echo "✗ ERROR: Expected 14 AoR stakeholders, found $AOR_COUNT"
            exit 1
          fi
          
          # Verify STK_CEGT exists
          if [ -d "CAXS/AoR/STK_CEGT" ]; then
            echo "✓ STK_CEGT directory exists"
          else
            echo "✗ ERROR: STK_CEGT directory missing"
            exit 1
          fi
          
          # Gate 3: Category-AoR constraints validation
          echo "Gate 3: Validating Category-AoR constraints..."
          if [ -f "configs/nomenclature/v6/category_aor_constraints.json" ]; then
            echo "✓ Category-AoR constraints config found"
          else
            echo "✗ ERROR: Missing category_aor_constraints.json"
            exit 1
          fi
          
          # Gate 4: KNOT range validation (K01-K14 only)
          echo "Gate 4: Validating KNOT range (K01-K14)..."
          KNOT_COUNT=$(find CAXS/KNOTS -maxdepth 1 -mindepth 1 -type d -name "K*" | wc -l)
          if [ "$KNOT_COUNT" -eq 14 ]; then
            echo "✓ All 14 KNOTS present (K01-K14)"
          else
            echo "✗ ERROR: Expected 14 KNOTS, found $KNOT_COUNT"
            exit 1
          fi
          
          # Gate 5: One official chain - validate exceptions mechanism exists
          echo "Gate 5: Validating one official chain mechanism..."
          if [ -f "CAXS/INFRASTRUCTURE/validators/exceptions.yml" ]; then
            echo "✓ Exceptions mechanism defined"
          else
            echo "⚠ Warning: Exceptions mechanism not yet defined"
          fi
          
          # Gate 6: .gitkeep presence validation
          echo "Gate 6: Validating .gitkeep presence in empty directories..."
          GITKEEP_COUNT=$(find CAXS -name ".gitkeep" | wc -l)
          echo "✓ Found $GITKEEP_COUNT .gitkeep files tracking empty directories"
          
          # Additional validation: ATA chapters
          echo ""
          echo "Additional: Validating ATA chapters (00-116)..."
          ATA_DIRS=$(find CAXS/ATA -type d -name "ATA-*" | wc -l)
          echo "✓ Found $ATA_DIRS ATA chapter directories"
          
          # Additional validation: Configuration files
          echo ""
          echo "Additional: Validating configuration files..."
          if [ -f "configs/nomenclature/v6/vocabulary.json" ]; then
            echo "✓ Vocabulary config present"
          else
            echo "✗ ERROR: Missing vocabulary.json"
            exit 1
          fi
          
          echo ""
          echo "=== All Portal Gates PASSED ==="

      - name: Linkcheck Portal Documentation
        run: |
          echo "=== Linkcheck Portal Documentation ==="
          if [ -f "CAXS/INFRASTRUCTURE/indexes/portal_entrypoints_index.md" ]; then
            echo "✓ Portal entrypoints index exists"
          else
            echo "✗ ERROR: Portal entrypoints index missing"
            exit 1
          fi
          
          if [ -f "CAXS/REPORTS/validation/ca360_portal_validation_report.md" ]; then
            echo "✓ Validation report template exists"
          else
            echo "✗ ERROR: Validation report template missing"
            exit 1
          fi
          
          # Check markdown links in key files
          echo ""
          echo "Validating markdown link integrity..."
          BROKEN_LINKS=0
          
          # Check portal entrypoints index links
          if grep -E '\[.*\]\(CAXS/.*\)' CAXS/INFRASTRUCTURE/indexes/portal_entrypoints_index.md > /dev/null; then
            echo "⚠ Info: Found relative links in portal entrypoints index"
          fi
          
          # Verify critical file references exist
          FILES_TO_CHECK=(
            "CAXS/INFRASTRUCTURE/validators/one_official_chain_uniqueness.md"
            "CAXS/INFRASTRUCTURE/validators/exceptions.yml"
            "configs/nomenclature/v6/vocabulary.json"
            "configs/nomenclature/v6/regex_constraints.json"
            "configs/nomenclature/v6/category_aor_constraints.json"
          )
          
          for file in "${FILES_TO_CHECK[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ Critical file exists: $file"
            else
              echo "✗ ERROR: Missing critical file: $file"
              BROKEN_LINKS=$((BROKEN_LINKS + 1))
            fi
          done
          
          if [ $BROKEN_LINKS -gt 0 ]; then
            echo "✗ ERROR: Found $BROKEN_LINKS broken references"
            exit 1
          fi
          
          echo "✓ Linkcheck PASSED"

      - name: Validate AoR SSOT Packs
        run: |
          echo "=== Validating AoR SSOT Registry Packs ==="
          echo ""
          
          # Define required registries per AoR
          REQUIRED_REGISTRIES=(
            "roadmap_registry.md"
            "task_registry.md"
            "evidence_index.md"
            "signoff_index.md"
          )
          
          # Define critical AoRs (PR-blocking enforcement)
          CRITICAL_AORS=(
            "STK_CM"
            "STK_PMO"
            "STK_CERT"
            "STK_SAF"
            "STK_TEST"
            "STK_CEGT"
          )
          
          echo "Critical AoRs requiring registry packs: ${CRITICAL_AORS[@]}"
          echo ""
          
          # Check critical AoRs with ERROR on missing packs
          CRITICAL_ERRORS=0
          for aor in "${CRITICAL_AORS[@]}"; do
            echo "Checking $aor registry pack (CRITICAL - PR-blocking)..."
            MISSING=0
            for registry in "${REQUIRED_REGISTRIES[@]}"; do
              if [ -f "CAXS/AoR/$aor/$registry" ]; then
                echo "  ✓ $aor/$registry present"
              else
                echo "  ✗ ERROR: $aor/$registry missing"
                MISSING=$((MISSING + 1))
              fi
            done
            
            if [ $MISSING -gt 0 ]; then
              echo "  ✗ ERROR: $aor registry pack incomplete ($MISSING missing files)"
              CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
            else
              echo "  ✓ $aor registry pack complete"
            fi
            echo ""
          done
          
          # Verify template pack exists
          if [ -d "CAXS/INFRASTRUCTURE/templates/aor_ssot_pack" ]; then
            echo "✓ AoR SSOT template pack exists"
          else
            echo "✗ ERROR: AoR SSOT template pack not found"
            exit 1
          fi
          
          # Fail if critical AoRs missing packs
          if [ $CRITICAL_ERRORS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $CRITICAL_ERRORS critical AoRs have incomplete registry packs"
            echo "ℹ Info: Use template pack in INFRASTRUCTURE/templates/aor_ssot_pack/ to create missing registries"
            exit 1
          fi
          
          echo "✓ All critical AoR SSOT packs complete"

      - name: Gate A - Intent Reference Validity
        run: |
          echo "=== Gate A: Intent Reference Validity ==="
          echo ""
          echo "Validating intent key references against SSOT registries..."
          
          # Check if SSOT registries exist
          VISION_REG=$(find CAXS/LEDGERS -name "*__vision-registry_REGISTRY_*.md" | head -1)
          MISSION_REG=$(find CAXS/LEDGERS -name "*__mission-registry_REGISTRY_*.md" | head -1)
          SCOPE_OUTCOME_REG=$(find CAXS/LEDGERS -name "*__scope-outcome-registry_REGISTRY_*.md" | head -1)
          
          if [ -z "$VISION_REG" ]; then
            echo "⚠ Warning: Vision Registry not found - skipping intent validation"
            exit 0
          fi
          
          if [ -z "$MISSION_REG" ]; then
            echo "⚠ Warning: Mission Registry not found - skipping intent validation"
            exit 0
          fi
          
          if [ -z "$SCOPE_OUTCOME_REG" ]; then
            echo "⚠ Warning: Scope & Outcome Registry not found - skipping intent validation"
            exit 0
          fi
          
          echo "✓ SSOT registries found:"
          echo "  Vision: $VISION_REG"
          echo "  Mission: $MISSION_REG"
          echo "  Scope & Outcome: $SCOPE_OUTCOME_REG"
          echo ""
          
          # Basic validation: check that registries contain valid tables
          echo "Validating registry structure..."
          
          # Check Vision Registry has VSN- entries
          VSN_COUNT=$(grep -c "^| VSN-" "$VISION_REG" || true)
          if [ "$VSN_COUNT" -gt 0 ]; then
            echo "✓ Vision Registry: $VSN_COUNT vision entries found"
          else
            echo "⚠ Warning: No vision entries found in Vision Registry"
          fi
          
          # Check Mission Registry has MSN- entries
          MSN_COUNT=$(grep -c "^| MSN-" "$MISSION_REG" || true)
          if [ "$MSN_COUNT" -gt 0 ]; then
            echo "✓ Mission Registry: $MSN_COUNT mission entries found"
          else
            echo "⚠ Warning: No mission entries found in Mission Registry"
          fi
          
          # Check Scope & Outcome Registry has SCP- and OUT- entries
          SCP_COUNT=$(grep -c "^| SCP-" "$SCOPE_OUTCOME_REG" || true)
          OUT_COUNT=$(grep -c "^| OUT-" "$SCOPE_OUTCOME_REG" || true)
          if [ "$SCP_COUNT" -gt 0 ]; then
            echo "✓ Scope Registry: $SCP_COUNT scope entries found"
          else
            echo "⚠ Warning: No scope entries found in Scope & Outcome Registry"
          fi
          if [ "$OUT_COUNT" -gt 0 ]; then
            echo "✓ Outcome Registry: $OUT_COUNT outcome entries found"
          else
            echo "⚠ Warning: No outcome entries found in Scope & Outcome Registry"
          fi
          
          echo ""
          echo "✓ Gate A: Intent reference SSOT registries validated"

      - name: Gate B - CIPP Determinism Validation
        run: |
          echo "=== Gate B: CIPP Determinism Validation ==="
          echo ""
          echo "Validating CIPP registry integrity..."
          
          # Check if CIPP Registry exists
          CIPP_REG=$(find CAXS/LEDGERS -name "*__cipp-registry_REGISTRY_*.md" | head -1)
          
          if [ -z "$CIPP_REG" ]; then
            echo "⚠ Warning: CIPP Registry not found - skipping CIPP validation"
            exit 0
          fi
          
          echo "✓ CIPP Registry found: $CIPP_REG"
          echo ""
          
          # Basic validation: check CIPP registry structure
          echo "Validating CIPP registry structure..."
          
          # Check for CIPP- entries
          CIPP_COUNT=$(grep -c "^| CIPP-" "$CIPP_REG" || true)
          if [ "$CIPP_COUNT" -gt 0 ]; then
            echo "✓ CIPP Registry: $CIPP_COUNT CIPP entries found"
          else
            echo "⚠ Warning: No CIPP entries found in CIPP Registry"
            exit 0
          fi
          
          # Extract CIPP entries and validate basic structure
          echo ""
          echo "Validating CIPP entry structure..."
          CIPP_ERRORS=0
          
          # Check that each CIPP entry has required fields
          # This is a basic check - full validation would require parsing
          if grep -E "^\| CIPP-[0-9]+ \|" "$CIPP_REG" > /dev/null; then
            echo "✓ CIPP entries follow expected format"
          else
            echo "✗ ERROR: CIPP entries do not follow expected format"
            CIPP_ERRORS=$((CIPP_ERRORS + 1))
          fi
          
          # Check for intent_hash column
          if grep "intent_hash" "$CIPP_REG" > /dev/null; then
            echo "✓ CIPP Registry includes intent_hash column"
          else
            echo "⚠ Warning: CIPP Registry missing intent_hash column"
          fi
          
          # Check for target_refs column
          if grep "target_refs" "$CIPP_REG" > /dev/null; then
            echo "✓ CIPP Registry includes target_refs column"
          else
            echo "⚠ Warning: CIPP Registry missing target_refs column"
          fi
          
          if [ $CIPP_ERRORS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $CIPP_ERRORS CIPP validation errors found"
            exit 1
          fi
          
          echo ""
          echo "✓ Gate B: CIPP determinism checks passed"

      - name: Gate C - Outcome Trace Completeness
        run: |
          echo "=== Gate C: Outcome Trace Completeness ==="
          echo ""
          echo "Validating outcome traceability..."
          
          # Check if required registries exist
          SCOPE_OUTCOME_REG=$(find CAXS/LEDGERS -name "*__scope-outcome-registry_REGISTRY_*.md" | head -1)
          CIPP_REG=$(find CAXS/LEDGERS -name "*__cipp-registry_REGISTRY_*.md" | head -1)
          
          if [ -z "$SCOPE_OUTCOME_REG" ]; then
            echo "⚠ Warning: Scope & Outcome Registry not found - skipping outcome trace validation"
            exit 0
          fi
          
          echo "✓ Scope & Outcome Registry found: $SCOPE_OUTCOME_REG"
          
          # Validate outcome registry structure
          echo ""
          echo "Validating outcome definitions..."
          
          # Check for outcome entries with required fields
          OUT_COUNT=$(grep -c "^| OUT-" "$SCOPE_OUTCOME_REG" || true)
          if [ "$OUT_COUNT" -gt 0 ]; then
            echo "✓ Found $OUT_COUNT outcome definitions"
          else
            echo "⚠ Warning: No outcome definitions found"
            exit 0
          fi
          
          # Check for required outcome fields
          if grep "metric_definition" "$SCOPE_OUTCOME_REG" > /dev/null; then
            echo "✓ Outcomes include metric definitions"
          else
            echo "⚠ Warning: Outcomes missing metric definitions"
          fi
          
          if grep "target_value" "$SCOPE_OUTCOME_REG" > /dev/null; then
            echo "✓ Outcomes include target values"
          else
            echo "⚠ Warning: Outcomes missing target values"
          fi
          
          if grep "evidence_hook" "$SCOPE_OUTCOME_REG" > /dev/null; then
            echo "✓ Outcomes include evidence hooks"
          else
            echo "⚠ Warning: Outcomes missing evidence hooks"
          fi
          
          # If CIPP Registry exists, validate outcome linkage
          if [ -n "$CIPP_REG" ]; then
            echo ""
            echo "Validating CIPP outcome linkage..."
            if grep "downstream_outcomes" "$CIPP_REG" > /dev/null; then
              echo "✓ CIPPs include downstream outcome references"
            else
              echo "⚠ Warning: CIPPs missing downstream outcome references"
            fi
          fi
          
          echo ""
          echo "✓ Gate C: Outcome trace completeness checks passed"

      - name: Gate D - ML Training Pipeline Readiness
        run: |
          echo "=== Gate D: ML Training Pipeline Readiness ==="
          echo ""
          echo "Validating baseline training pipeline infrastructure..."
          
          # Check for ML pipeline structure
          echo "Checking ML pipeline directory structure..."
          REQUIRED_DIRS=(
            "src/ca360_ml"
            "configs/ml"
            "data/schemas"
            "data/manifests"
            "data/samples"
          )
          
          MISSING_DIRS=0
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "  ✓ $dir exists"
            else
              echo "  ✗ ERROR: Missing directory $dir"
              MISSING_DIRS=$((MISSING_DIRS + 1))
            fi
          done
          
          if [ $MISSING_DIRS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $MISSING_DIRS required directories missing"
            exit 1
          fi
          
          # Check for core ML pipeline files
          echo ""
          echo "Checking ML pipeline core files..."
          REQUIRED_FILES=(
            "pyproject.toml"
            "src/ca360_ml/__init__.py"
            "src/ca360_ml/cli.py"
            "src/ca360_ml/data.py"
            "src/ca360_ml/train.py"
            "src/ca360_ml/eval.py"
            "src/ca360_ml/reproducibility.py"
            "src/ca360_ml/package.py"
          )
          
          MISSING_FILES=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file exists"
            else
              echo "  ✗ ERROR: Missing file $file"
              MISSING_FILES=$((MISSING_FILES + 1))
            fi
          done
          
          if [ $MISSING_FILES -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $MISSING_FILES required files missing"
            exit 1
          fi
          
          # Check for schemas
          echo ""
          echo "Checking schema definitions..."
          if [ -f "data/schemas/provenance.schema.json" ]; then
            echo "  ✓ Provenance schema defined"
          else
            echo "  ✗ ERROR: Missing provenance.schema.json"
            exit 1
          fi
          
          if [ -f "data/schemas/dataset.schema.json" ]; then
            echo "  ✓ Dataset schema defined"
          else
            echo "  ✗ ERROR: Missing dataset.schema.json"
            exit 1
          fi
          
          # Check for baseline configuration
          echo ""
          echo "Checking baseline configurations..."
          if [ -f "configs/ml/baseline.yaml" ]; then
            echo "  ✓ Baseline configuration present"
          else
            echo "  ✗ ERROR: Missing baseline.yaml"
            exit 1
          fi
          
          # Check for dataset manifest
          echo ""
          echo "Checking dataset manifests..."
          MANIFEST_COUNT=$(find data/manifests -name "*.json" 2>/dev/null | wc -l)
          if [ "$MANIFEST_COUNT" -gt 0 ]; then
            echo "  ✓ Found $MANIFEST_COUNT dataset manifest(s)"
          else
            echo "  ✗ ERROR: No dataset manifests found"
            exit 1
          fi
          
          # Check for CI sample data
          echo ""
          echo "Checking CI sample data..."
          if [ -f "data/samples/ci_sample.csv" ]; then
            echo "  ✓ CI sample dataset present"
          else
            echo "  ✗ ERROR: Missing ci_sample.csv"
            exit 1
          fi
          
          # Check for train_eval workflow
          echo ""
          echo "Checking training workflow..."
          if [ -f ".github/workflows/train_eval.yml" ]; then
            echo "  ✓ Train+Eval workflow defined"
          else
            echo "  ⚠ Warning: train_eval.yml workflow not found"
          fi
          
          echo ""
          echo "✓ Gate D: ML Training Pipeline infrastructure complete"

      - name: Gate E - TALF (Tool Access & Licensing Fabric) Validation
        run: |
          echo "=== Gate E: TALF Validation ==="
          echo ""
          echo "Validating Tool Access & Licensing Fabric infrastructure..."
          
          # Check for TALF infrastructure catalogs
          echo "Checking TALF infrastructure catalogs..."
          REQUIRED_TALF_FILES=(
            "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml"
            "CAXS/INFRASTRUCTURE/access/entitlement_matrix.csv"
            "CAXS/INFRASTRUCTURE/access/license_events_registry.md"
          )
          
          MISSING_TALF_FILES=0
          for file in "${REQUIRED_TALF_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file exists"
            else
              echo "  ✗ ERROR: Missing TALF infrastructure file $file"
              MISSING_TALF_FILES=$((MISSING_TALF_FILES + 1))
            fi
          done
          
          if [ $MISSING_TALF_FILES -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $MISSING_TALF_FILES required TALF files missing"
            exit 1
          fi
          
          # Validate tool_catalog.yaml structure
          echo ""
          echo "Validating tool_catalog.yaml structure..."
          if grep -q "tools:" "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml"; then
            echo "  ✓ tool_catalog.yaml has tools section"
          else
            echo "  ✗ ERROR: tool_catalog.yaml missing tools section"
            exit 1
          fi
          
          if grep -q "tool_id:" "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml"; then
            TOOL_COUNT=$(grep -c "tool_id:" "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml" || true)
            echo "  ✓ Found $TOOL_COUNT tool definitions"
          else
            echo "  ✗ ERROR: No tool_id entries found in tool_catalog.yaml"
            exit 1
          fi
          
          # Validate entitlement_matrix.csv structure
          echo ""
          echo "Validating entitlement_matrix.csv structure..."
          if head -1 "CAXS/INFRASTRUCTURE/access/entitlement_matrix.csv" | grep -q "tool_id,entitlement_group"; then
            echo "  ✓ entitlement_matrix.csv has correct header"
          else
            echo "  ✗ ERROR: entitlement_matrix.csv missing correct header"
            exit 1
          fi
          
          ENTITLEMENT_COUNT=$(tail -n +2 "CAXS/INFRASTRUCTURE/access/entitlement_matrix.csv" | grep -c .)
          if [ "$ENTITLEMENT_COUNT" -gt 0 ]; then
            echo "  ✓ Found $ENTITLEMENT_COUNT entitlement mappings"
          else
            echo "  ✗ ERROR: No entitlement mappings found"
            exit 1
          fi
          
          # Cross-validate: check that tool_ids in entitlement_matrix exist in tool_catalog
          echo ""
          echo "Cross-validating tool_ids between catalog and entitlement matrix..."
          INVALID_TOOLS=0
          while IFS=',' read -r tool_id rest; do
            if [ "$tool_id" != "tool_id" ]; then
              if grep -q "tool_id: $tool_id" "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml"; then
                echo "  ✓ tool_id '$tool_id' exists in catalog"
              else
                echo "  ✗ ERROR: tool_id '$tool_id' in entitlement_matrix not found in catalog"
                INVALID_TOOLS=$((INVALID_TOOLS + 1))
              fi
            fi
          done < "CAXS/INFRASTRUCTURE/access/entitlement_matrix.csv"
          
          if [ $INVALID_TOOLS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $INVALID_TOOLS invalid tool_id references found"
            exit 1
          fi
          
          # Check for PHM PORTAL structure
          echo ""
          echo "Checking PHM PORTAL structure..."
          PHM_PORTAL_DIRS=(
            "CAXS/AoR/STK_PHM/PORTAL"
            "CAXS/AoR/STK_PHM/PORTAL/DELIVERABLES"
            "CAXS/AoR/STK_PHM/PORTAL/REGISTRIES"
            "CAXS/AoR/STK_PHM/PORTAL/LINKS"
          )
          
          MISSING_PHM_DIRS=0
          for dir in "${PHM_PORTAL_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "  ✓ $dir exists"
            else
              echo "  ⚠ Warning: $dir not found (optional for other AoRs)"
              MISSING_PHM_DIRS=$((MISSING_PHM_DIRS + 1))
            fi
          done
          
          # Check for PHM TALF deliverable
          echo ""
          echo "Checking PHM TALF deliverable..."
          if [ -f "CAXS/AoR/STK_PHM/PORTAL/DELIVERABLES/00_AMPEL360_SPACET_Q10_GEN_PLUS_PR_00_LC01_K01_STK_PHM__talf-tool-access-licensing-fabric_DELIVERABLE_PROC_I01-R01_DRAFT.md" ]; then
            echo "  ✓ PHM TALF deliverable exists"
          else
            echo "  ⚠ Warning: PHM TALF deliverable not found"
          fi
          
          # Check for PHM PORTAL registries
          echo ""
          echo "Checking PHM PORTAL registries..."
          PHM_PORTAL_REGISTRIES=(
            "CAXS/AoR/STK_PHM/PORTAL/REGISTRIES/task_registry.md"
            "CAXS/AoR/STK_PHM/PORTAL/REGISTRIES/roadmap_registry.md"
            "CAXS/AoR/STK_PHM/PORTAL/REGISTRIES/evidence_index.md"
            "CAXS/AoR/STK_PHM/PORTAL/REGISTRIES/signoff_index.md"
          )
          
          for registry in "${PHM_PORTAL_REGISTRIES[@]}"; do
            if [ -f "$registry" ]; then
              echo "  ✓ $(basename $registry) exists"
            else
              echo "  ⚠ Warning: $(basename $registry) not found"
            fi
          done
          
          # Validate license_events_registry structure
          echo ""
          echo "Validating license_events_registry structure..."
          if grep -q "Event Types" "CAXS/INFRASTRUCTURE/access/license_events_registry.md"; then
            echo "  ✓ license_events_registry has Event Types section"
          else
            echo "  ⚠ Warning: license_events_registry missing Event Types section"
          fi
          
          if grep -q "Event Schema" "CAXS/INFRASTRUCTURE/access/license_events_registry.md"; then
            echo "  ✓ license_events_registry has Event Schema section"
          else
            echo "  ⚠ Warning: license_events_registry missing Event Schema section"
          fi
          
          # Check for required fields in tool_catalog
          echo ""
          echo "Validating required fields in tool_catalog..."
          REQUIRED_FIELDS=(
            "tool_class"
            "display_name"
            "delivery_channel"
            "licensing"
            "access"
            "workspace"
            "preflight_checks"
          )
          
          MISSING_FIELDS=0
          for field in "${REQUIRED_FIELDS[@]}"; do
            if grep -q "$field:" "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml"; then
              echo "  ✓ Field '$field' found in catalog"
            else
              echo "  ✗ ERROR: Required field '$field' missing from catalog"
              MISSING_FIELDS=$((MISSING_FIELDS + 1))
            fi
          done
          
          if [ $MISSING_FIELDS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $MISSING_FIELDS required fields missing from tool_catalog"
            exit 1
          fi
          
          echo ""
          echo "✓ Gate E: TALF validation complete"

      - name: Gate F - Portal Contract Validation
        run: |
          echo "=== Gate F: Portal Contract Validation ==="
          echo ""
          echo "Validating AoR portal contracts..."
          
          # Define all AoRs that should have contracts
          ALL_AORS=(
            "STK_CM"
            "STK_PMO"
            "STK_SE"
            "STK_DAB"
            "STK_PHM"
            "STK_SAF"
            "STK_CERT"
            "STK_TEST"
            "STK_OPS"
            "STK_MRO"
            "STK_AI"
            "STK_CY"
            "STK_SPACEPORT"
            "STK_CEGT"
          )
          
          echo "Checking portal contracts for all 14 AoRs..."
          echo ""
          
          MISSING_CONTRACTS=0
          INVALID_CONTRACTS=0
          
          for aor in "${ALL_AORS[@]}"; do
            CONTRACT_FILE="CAXS/AoR/$aor/PORTAL/00_AMPEL360_SPACET_Q10_BASELINE_PLUS_PR_00_LC01_K01_${aor}__portal-contract_REGISTRY_REG_I01-R01_ACTIVE.yaml"
            
            if [ -f "$CONTRACT_FILE" ]; then
              echo "✓ $aor: Contract file exists"
              
              # Validate contract structure
              echo "  Validating $aor contract structure..."
              
              # Check for required sections
              REQUIRED_SECTIONS=(
                "contract_metadata"
                "default_context"
                "features"
                "tool_launchpad"
                "execution"
                "backend"
              )
              
              MISSING_SECTIONS=0
              for section in "${REQUIRED_SECTIONS[@]}"; do
                if grep -q "$section:" "$CONTRACT_FILE"; then
                  echo "    ✓ Section '$section' present"
                else
                  echo "    ✗ ERROR: Section '$section' missing"
                  MISSING_SECTIONS=$((MISSING_SECTIONS + 1))
                fi
              done
              
              if [ $MISSING_SECTIONS -gt 0 ]; then
                echo "  ✗ ERROR: $aor contract incomplete ($MISSING_SECTIONS missing sections)"
                INVALID_CONTRACTS=$((INVALID_CONTRACTS + 1))
              else
                echo "  ✓ $aor contract structure valid"
              fi
              
              # Validate aor_id matches
              if grep -q "aor_id: $aor" "$CONTRACT_FILE"; then
                echo "  ✓ aor_id matches filename"
              else
                echo "  ✗ ERROR: aor_id does not match filename"
                INVALID_CONTRACTS=$((INVALID_CONTRACTS + 1))
              fi
              
              # Check for MUST features (F01-F09)
              echo "  Checking MUST features..."
              MUST_FEATURES=("F01" "F02" "F03" "F04" "F05" "F06" "F07" "F08" "F09")
              MISSING_MUST=0
              
              for feature in "${MUST_FEATURES[@]}"; do
                if grep -q "- $feature" "$CONTRACT_FILE"; then
                  true  # Feature found
                else
                  echo "    ✗ ERROR: MUST feature $feature missing"
                  MISSING_MUST=$((MISSING_MUST + 1))
                fi
              done
              
              if [ $MISSING_MUST -gt 0 ]; then
                echo "  ✗ ERROR: $MISSING_MUST MUST features missing from $aor contract"
                INVALID_CONTRACTS=$((INVALID_CONTRACTS + 1))
              else
                echo "  ✓ All MUST features present"
              fi
              
              # Validate tool references exist in tool_catalog.yaml
              echo "  Validating tool references..."
              TOOL_IDS=$(grep "tool_id:" "$CONTRACT_FILE" | awk '{print $2}' | sort -u)
              
              if [ -f "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml" ]; then
                INVALID_TOOLS=0
                for tool_id in $TOOL_IDS; do
                  if grep -q "tool_id: $tool_id" "CAXS/INFRASTRUCTURE/access/tool_catalog.yaml"; then
                    echo "    ✓ Tool '$tool_id' exists in catalog"
                  else
                    echo "    ⚠ Warning: Tool '$tool_id' not found in catalog (may be defined inline)"
                  fi
                done
              else
                echo "    ✗ ERROR: Tool catalog not found - required for tool validation"
                INVALID_CONTRACTS=$((INVALID_CONTRACTS + 1))
              fi
              
            else
              echo "✗ ERROR: $aor contract missing at $CONTRACT_FILE"
              MISSING_CONTRACTS=$((MISSING_CONTRACTS + 1))
            fi
            
            echo ""
          done
          
          # Summary
          echo "=== Contract Validation Summary ==="
          echo "Total AoRs: ${#ALL_AORS[@]}"
          echo "Missing contracts: $MISSING_CONTRACTS"
          echo "Invalid contracts: $INVALID_CONTRACTS"
          
          if [ $MISSING_CONTRACTS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $MISSING_CONTRACTS AoR(s) missing portal contracts"
            exit 1
          fi
          
          if [ $INVALID_CONTRACTS -gt 0 ]; then
            echo ""
            echo "✗ ERROR: $INVALID_CONTRACTS AoR(s) have invalid portal contracts"
            exit 1
          fi
          
          echo ""
          echo "✓ Gate F: All portal contracts validated successfully"
