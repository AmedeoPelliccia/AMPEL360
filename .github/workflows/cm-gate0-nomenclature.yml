name: CM Gate0 - Nomenclature v6.0 (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  gate0-nomenclature:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Compute changed files (PR)
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          if ! git fetch --no-tags origin "${BASE_SHA}"; then
            echo "Warning: Failed to fetch BASE_SHA ${BASE_SHA}. Falling back to base ref ${BASE_REF}."
            git fetch --no-tags origin "${BASE_REF}"
            BASE_SHA="$(git rev-parse "origin/${BASE_REF}")"
          fi
          git diff --name-only --diff-filter=ACMRT "${BASE_SHA}" "${HEAD_SHA}" > changed_files.txt
          echo "Changed files:"
          sed -n '1,200p' changed_files.txt

      - name: Run Collector - collect_nomenclature_tokens
        shell: bash
        run: |
          set -euo pipefail
          CM_CI_ROOT="CAXS/AoR/STK_CM/PORTAL/PROGRAM_SPACET/FAMILY_Q10/VARIANT_PLUS/VERSION_GENERATION/SYSTEM_ATA-00_Spacecraft/BLOCK_10_Operational_Systems/MODEL_SOFTWARE/LC00_GENERAL/CI"
          python "${CM_CI_ROOT}/collectors/python/collect_nomenclature_tokens.py" \
            --repo-root "." \
            --changed-files "changed_files.txt" \
            --out-dir "artifacts/collectors/collect_nomenclature_tokens" \
            --annotations "github" \
            --check-path-scope "true" \
            --ignore-prefix ".github/" \
            --ignore-prefix "artifacts/" \
            --ignore-basename "README.md" \
            --ignore-basename "CHANGELOG.md" \
            --ignore-basename ".gitkeep" \
            --ignore-ext "py"

      - name: Run Gate 0 - gate0_nomenclature_vocab
        shell: bash
        run: |
          set -euo pipefail
          CM_CI_ROOT="CAXS/AoR/STK_CM/PORTAL/PROGRAM_SPACET/FAMILY_Q10/VARIANT_PLUS/VERSION_GENERATION/SYSTEM_ATA-00_Spacecraft/BLOCK_10_Operational_Systems/MODEL_SOFTWARE/LC00_GENERAL/CI"
          python "${CM_CI_ROOT}/gates/gate0_nomenclature_vocab.py" \
            --collector-json "artifacts/collectors/collect_nomenclature_tokens/collector_output.json" \
            --out-dir "artifacts/gates/gate0_nomenclature_vocab" \
            --warnings-blocking "true"

      - name: Upload collector output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collect_nomenclature_tokens-output
          path: artifacts/collectors/collect_nomenclature_tokens

      - name: Upload gate output artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate0_nomenclature_vocab-output
          path: artifacts/gates/gate0_nomenclature_vocab
